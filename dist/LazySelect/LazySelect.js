"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0,require("core-js/modules/web.dom-collections.iterator.js"),require("core-js/modules/es.promise.js"),require("core-js/modules/es.string.includes.js"),require("./LazySelect.css");var _react=_interopRequireWildcard(require("react")),_reactDom=_interopRequireDefault(require("react-dom")),_TagsInput=_interopRequireDefault(require("../TagsInput/TagsInput")),_HTTPHelper=require("../Common/HTTPHelper"),_ScrollHelper=require("../Common/ScrollHelper"),_LogHelper=_interopRequireDefault(require("../Common/LogHelper")),_CommonHelper=require("../Common/CommonHelper"),_LazyOption=_interopRequireDefault(require("./LazyOption"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _getRequireWildcardCache(a){if("function"!=typeof WeakMap)return null;var b=new WeakMap,c=new WeakMap;return(_getRequireWildcardCache=function(a){return a?c:b})(a)}function _interopRequireWildcard(a,b){if(!b&&a&&a.__esModule)return a;if(null===a||"object"!=typeof a&&"function"!=typeof a)return{default:a};var c=_getRequireWildcardCache(b);if(c&&c.has(a))return c.get(a);var d={},e=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var f in a)if("default"!=f&&Object.prototype.hasOwnProperty.call(a,f)){var g=e?Object.getOwnPropertyDescriptor(a,f):null;g&&(g.get||g.set)?Object.defineProperty(d,f,g):d[f]=a[f]}return d.default=a,c&&c.set(a,d),d}function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}const LazySelect=/*#__PURE__*/_react.default.memo(a=>{var b;const{ApiURL:c,UniqueKey:d,DisplayBy:e,Filterable:f=!0,PlaceHolder:g="Select Items ...",AxiosInstance:h=null,useQueryParams:i=!1,useBodyParams:j=!1,RequestMethod:k="post",ExistingRequestParams:l={},ExistingRequestHeaders:m={},usePathParams:n=!1,PathParameterArrangement:o=[],PageSize:p=10,InitialStartFrom:q=1,SearchRequestParamName:r="search",StartFromRequestParamName:s="from",PageSizeRequestParamName:t="size",ResponseResultsHierarchy:u="",DisplayCheckBoxForOptions:v=!0,DisplayShowMoreOption:w=!0,MaximunOptionToShow:x=1,DisplayShowMoreOptionCallBack:y=()=>{},SelectionChangedCallBack:z=()=>{},SelectedDataList:A=[],IsMulti:B=!0,ShowTags:C=!0,Virtualized:D=!1,numVisibleItems:E=10,itemheight:F=36.4,OptionsBoxHeight:G=250,OpenOnRendering:H=!1,PerformCustomLoginOnOption:I=null,OnDropDownClosed:J=()=>{},RenderOptionComponent:K=null,RenderTagComponent:L=null,RenderInputComponent:M=null,RenderLimitComponent:N=null,OnInputPasteHandler:O=()=>{},EnsureSelectedDataListRenderedInOptions:P=!1}=a;if(!d)throw new Error("the name of the UniqueKey of your data must be provided");if(!c)throw new Error("ApiURL for your data must be provided");const[Q,R]=(0,_react.useState)(""),[S,T]=(0,_react.useState)(!1),[U,V]=(0,_react.useState)(!1),[W,X]=(0,_react.useState)(!1),[Y,Z]=(0,_react.useState)(!1),[$,_]=(0,_react.useState)(!1),[aa,ba]=(0,_react.useState)(!1),[ca,da]=(0,_react.useState)([]),[ea,fa]=(0,_react.useState)(A),[ga,ha]=(0,_react.useState)(!0),[ia,ja]=(0,_react.useState)(q),[ka,la]=(0,_react.useState)(-1),[ma,na]=(0,_react.useState)({start:0,end:E}),oa=(0,_react.useRef)(null),pa=(0,_react.useRef)(null),qa=(0,_react.useRef)(null),ra=(0,_react.useRef)(null),sa=function(){let a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null,b=c,d={};if(i){for(const a in b+="?",l)b+="".concat(a,"=").concat(l[a],"&");b+="".concat(r,"=").concat(Q,"&"),b+="".concat(s,"=").concat(null==a?ia:a,"&"),b+="".concat(t,"=").concat(p)}else if(n){const c=_objectSpread(_objectSpread({},(0,_CommonHelper.flattenObject)(l)),{},{[r]:Q,[s]:null==a?ia:a,[t]:p});_LogHelper.default.LogMessage("flatten object",c),o.forEach(a=>{c.hasOwnProperty(a)&&(b+="/".concat(c[a]))}),_LogHelper.default.LogMessage("base url ",b)}else j&&(d=_objectSpread({},l),d[r]=Q,d[s]=null==a?ia:a,d[t]=p);return{method:k,baseURL:b,data:d,headers:m}},ta=(0,_react.useRef)(sa(null)),ua=async function(){let a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;X(!0),Z(!1);const b=sa(a);if(_LogHelper.default.LogMessage("Request Info FROM",b.data[s]),_LogHelper.default.LogMessage("previous request info FROM",ta.current.data[s]),b.data[s]===q||b.data[s]!==ta.current.data[s]){let a=await(0,_HTTPHelper.getDataList)(h,b.method,b.baseURL,b.data,b.headers);if(a.success){let b=q;da(c=>{var e,f,g;_LogHelper.default.LogMessage(a.data);let h=(0,_HTTPHelper.parseResponseResultsHierarchy)(u,a.data);if(_LogHelper.default.LogMessage(h),null!=I){var i;h=null===(i=h)||void 0===i?void 0:i.map((a,b)=>I(a,b,b+c.length))}const j=null===c||void 0===c?void 0:c.map(a=>a[d]),k=null!==(e=null===(f=h)||void 0===f?void 0:f.filter(a=>j.includes(a[d])))&&void 0!==e?e:[];if(0<k.length){var l,m;_LogHelper.default.LogWarning("there is some duplication in the data, we will remove the duplicated options for you, but you need to fix this issue, the duplicated data are:"),_LogHelper.default.LogWarning(k),h=null!==(l=null===(m=h)||void 0===m?void 0:m.filter(a=>!j.includes(a[d])))&&void 0!==l?l:[]}if(P){var n,o;const a=ea.map(a=>a[d]);h=null!==(n=null===(o=h)||void 0===o?void 0:o.filter(b=>!a.includes(b[d])))&&void 0!==n?n:[]}const p=[...(null!==c&&void 0!==c?c:[]),...(null!==(g=h)&&void 0!==g?g:[])];return b=0===p.length?q:p.length,p}),ja(b+q),_LogHelper.default.LogMessage("new start from",b+q)}else Z(!0);ta.current=b}S&&T(!1),U&&V(!1),aa&&ba(!1),X(!1)};(0,_react.useEffect)(()=>{aa&&(ja(q),da([]),ua(q))},[aa]),(0,_react.useEffect)(()=>{S&&(_LogHelper.default.LogMessage("useEffect for scroll"),ua())},[S]),(0,_react.useEffect)(()=>{W?ha(!0):$&&ha(!1)},[W]),(0,_react.useEffect)(()=>{if(!ga){var a;null===ra||void 0===ra||null===(a=ra.current)||void 0===a?void 0:a.focus()}},[ga]),(0,_react.useEffect)(()=>{const a=setTimeout(()=>{U&&(ja(q),da([]),_LogHelper.default.LogMessage("useEffect for search"),ua(q))},500);return()=>clearTimeout(a)},[Q]);const va=(0,_react.useCallback)((a,b)=>{B?fa(c=>a?[...c,b]:[...c.filter(a=>a[d]!==b[d])]):fa(()=>a?(R(b[e]),[b]):[]),P&&!a&&da(a=>[b,...a])}),wa=(a,b)=>{let c=b.find(b=>b[d]===a[d]);return!!c},xa=a=>{a.target.value!==Q&&(R(a.target.value),V(!0))},ya=()=>{$?(_(!1),R(""),ja(q),da([]),ha(!0),J(ea)):(_(!0),ba(!0),ha(!1))};(0,_react.useEffect)(()=>{H&&ya()},[H]);const za=a=>{let b=Math.trunc(a.scrollTop/F);b=b-E>=ca.length?b-E:b,b!==ma.start&&na({start:b,end:b+E>=ca.length?ca.length-1:b+E})},Aa=(0,_react.useRef)(!1),Ba=(0,_react.useRef)(!0);(0,_react.useLayoutEffect)(()=>Ba.current?void(Ba.current=!1):void z(ea),[ea]);const Ca=a=>{_LogHelper.default.LogMessage("from key down",ca);let b=-1;if(0!==ca.length)if(38===a.keyCode&&0<ka)la(a=>(b=a-1,b)),Da();else if(40===a.keyCode&&ka<ca.length-1)la(a=>(b=a+1,b)),Da();else if(13===a.keyCode){var c;let a=_objectSpread({},ca[ka]),b=null!==(c=ea.find(b=>b[d]===a[d]))&&void 0!==c&&c;va(!b,a)}},Da=()=>{pa.current&&pa.current.scrollIntoView({behavior:"smooth",block:"end",inline:"nearest"})};(0,_react.useEffect)(()=>(document.addEventListener("keydown",Ca),()=>{document.removeEventListener("keydown",Ca)})),_LogHelper.default.LogMessage("local data length",ca.length);const Ea=D?{height:ca.length*F,minHeight:ca.length*F}:{};let Fa=null===(b=qa.current)||void 0===b?void 0:b.getBoundingClientRect();return/*#__PURE__*/_react.default.createElement("div",{className:"lazyselect-select",ref:qa},/*#__PURE__*/_react.default.createElement("div",{onClick:a=>{(a.target.classList.contains("icon")||a.target.classList.contains("lazyselect-select-output")||a.target.classList.contains("arrow"))&&ya()},className:$?"lazyselect-select-output active":"lazyselect-select-output"},(()=>{if(B){if(C)return/*#__PURE__*/_react.default.createElement(_TagsInput.default,{uniqueKey:d,displayBy:e,Filterable:f,placeHolder:g,selectedDataList:ea,renderedSelectedDataList:0>=x?ea:ea.slice(0,x),onSearchChange:xa,searchValue:Q,handleOptionSelectedUnselected:va,displayShowMoreOption:w,maximunOptionToShow:x,displayShowMoreOptionCallBack:y,tagsInputDisabled:ga,RenderTagComponent:L,RenderLimitComponent:N,RenderInputComponent:M,OnInputPasteHandler:O,onKeyDown:Ca});}else if(ea[0])return/*#__PURE__*/_react.default.createElement("div",{className:"tags-input"},null==M?/*#__PURE__*/_react.default.createElement("input",{style:{height:"100%"},ref:ra,autoFocus:!0,disabled:ga||!f,type:"text",value:Q,onChange:xa,placeholder:ea[0][e],title:ea[0][e],onPaste:O}):M({style:{height:"100%"},ref:ra,disabled:ga||!f,type:"text",value:Q,onChange:xa,placeholder:ea[0][e],title:ea[0][e]}));return/*#__PURE__*/_react.default.createElement("div",{className:"tags-input"},null==M?/*#__PURE__*/_react.default.createElement("input",{style:{height:"100%"},ref:ra,autoFocus:!0,disabled:ga||!f,type:"text",onChange:xa,value:Q,placeholder:g,onPaste:O}):M({style:{height:"100%"},ref:ra,disabled:ga||!f,type:"text",onChange:xa,value:Q,placeholder:g}))})(),/*#__PURE__*/_react.default.createElement("div",{className:"icon"},/*#__PURE__*/_react.default.createElement("i",{className:"arrow ".concat($?"up":"down")}))),$&&/*#__PURE__*/_reactDom.default.createPortal(/*#__PURE__*/_react.default.createElement("div",{ref:oa,className:$?"lazyselect-select-box show":"lazyselect-select-box",onScroll:()=>{const a=oa.current;D&&za(a);const b=(0,_ScrollHelper.isElementAtBottom)(a,.98);b&&b!==Aa.current&&T(!0),Aa.current=b},style:{width:Fa.width,height:G}},/*#__PURE__*/_react.default.createElement("div",{className:"lazyselectcheckbox-list-container",style:Ea},(()=>{let a=ca;if(P){const b=null===ca||void 0===ca?void 0:ca.map(a=>a[d]);a=[...ea.filter(a=>!b.includes(a[d])),...ca]}return a.map((a,b)=>{if(D&&!(b>=ma.start&&b<=ma.end))return null;let c=wa(a,ea),d=ka===b;return null==K?/*#__PURE__*/_react.default.createElement(_LazyOption.default,{key:b,index:b,oRef:d?pa:null,id:"lazyselectcheckbox-container-".concat(b),setCursor:la,optionSelected:c,optionActive:d,DisplayCheckBoxForOptions:v,handleOptionSelectedUnselected:va,value:a,DisplayBy:e,itemheight:F,Virtualized:D,FirstVirtualOption:!!D&&b===ma.start}):K({key:b,index:b,ref:d?pa:null,id:"lazyselectcheckbox-container-".concat(b),setCursor:la,optionSelected:c,optionActive:d,DisplayCheckBoxForOptions:v,handleOptionSelectedUnselected:va,optionValue:a,DisplayBy:e,itemheight:F,Virtualized:D,FirstVirtualOption:!!D&&b===ma.start})})})()),W&&/*#__PURE__*/_react.default.createElement("div",{className:"lazyselect-select-buttons"},"Loading ...."),Y&&/*#__PURE__*/_react.default.createElement("div",{className:"lazyselect-select-buttons"},"Somthing went wrong!, Check your server!"),!W&&!Y&&0===ca.length&&/*#__PURE__*/_react.default.createElement("div",{className:"lazyselect-select-buttons"},"No Items Found!..")),qa.current))});var _default=LazySelect;exports.default=_default;