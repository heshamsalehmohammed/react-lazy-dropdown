"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0,require("core-js/modules/web.dom-collections.iterator.js"),require("core-js/modules/es.promise.js"),require("core-js/modules/es.string.includes.js"),require("./LazySelect.css");var _react=_interopRequireWildcard(require("react")),_TagsInput=_interopRequireDefault(require("../TagsInput/TagsInput")),_HTTPHelper=require("../Common/HTTPHelper"),_ScrollHelper=require("../Common/ScrollHelper"),_LogHelper=_interopRequireDefault(require("../Common/LogHelper")),_CommonHelper=require("../Common/CommonHelper"),_LazyOption=_interopRequireDefault(require("./LazyOption"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _getRequireWildcardCache(a){if("function"!=typeof WeakMap)return null;var b=new WeakMap,c=new WeakMap;return(_getRequireWildcardCache=function(a){return a?c:b})(a)}function _interopRequireWildcard(a,b){if(!b&&a&&a.__esModule)return a;if(null===a||"object"!=typeof a&&"function"!=typeof a)return{default:a};var c=_getRequireWildcardCache(b);if(c&&c.has(a))return c.get(a);var d={},e=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var f in a)if("default"!=f&&Object.prototype.hasOwnProperty.call(a,f)){var g=e?Object.getOwnPropertyDescriptor(a,f):null;g&&(g.get||g.set)?Object.defineProperty(d,f,g):d[f]=a[f]}return d.default=a,c&&c.set(a,d),d}function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}const LazySelect=/*#__PURE__*/_react.default.memo(a=>{const{ApiURL:b,UniqueKey:c,DisplayBy:d,Filterable:e=!0,PlaceHolder:f="Select Items ...",AxiosInstance:g=null,useQueryParams:h=!1,useBodyParams:i=!1,RequestMethod:j="post",ExistingRequestParams:k={},ExistingRequestHeaders:l={},usePathParams:m=!1,PathParameterArrangement:n=[],PageSize:o=10,InitialStartFrom:p=1,SearchRequestParamName:q="search",StartFromRequestParamName:r="from",PageSizeRequestParamName:s="size",ResponseResultsHierarchy:t="",DisplayCheckBoxForOptions:u=!0,DisplayShowMoreOption:v=!0,MaximunOptionToShow:w=-1,DisplayShowMoreOptionCallBack:x=()=>{},SelectionChangedCallBack:y=()=>{},IsMulti:z=!0,ShowTags:A=!0,TagComponent:B=null,ShowMoreComponent:C=null,Virtualized:D=!1,numVisibleItems:E=10,itemheight:F=36.4}=a;if(!c)throw new Error("the name of the UniqueKey of your data must be provided");if(!b)throw new Error("ApiURL for your data must be provided");const[G,H]=(0,_react.useState)(""),[I,J]=(0,_react.useState)(!1),[K,L]=(0,_react.useState)(!1),[M,N]=(0,_react.useState)(!1),[O,P]=(0,_react.useState)(!1),[Q,R]=(0,_react.useState)(!1),[S,T]=(0,_react.useState)(!1),[U,V]=(0,_react.useState)([]),[W,X]=(0,_react.useState)([]),[Y,Z]=(0,_react.useState)(!0),[$,_]=(0,_react.useState)(p),[aa,ba]=(0,_react.useState)({start:0,end:E}),ca=(0,_react.useRef)(null),da=(0,_react.useRef)(null),ea=function(){let a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null,c=b,d={};if(h){for(const a in c+="?",k)c+="".concat(a,"=").concat(k[a],"&");c+="".concat(q,"=").concat(G,"&"),c+="".concat(r,"=").concat(null==a?$:a,"&"),c+="".concat(s,"=").concat(o)}else if(m){const b=_objectSpread(_objectSpread({},(0,_CommonHelper.flattenObject)(k)),{},{[q]:G,[r]:null==a?$:a,[s]:o});_LogHelper.default.LogMessage("flatten object",b),n.forEach(a=>{b.hasOwnProperty(a)&&(c+="/".concat(b[a]))}),_LogHelper.default.LogMessage("base url ",c)}else i&&(d=_objectSpread({},k),d[q]=G,d[r]=null==a?$:a,d[s]=o);return{method:j,baseURL:c,data:d,headers:l}},fa=(0,_react.useRef)(ea(null)),ga=async function(){let a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;N(!0),P(!1);const b=ea(a);if(_LogHelper.default.LogMessage("Request Info FROM",b.data[r]),_LogHelper.default.LogMessage("previous request info FROM",fa.current.data[r]),b.data[r]===p||b.data[r]!==fa.current.data[r]){let a=await(0,_HTTPHelper.getDataList)(g,b.method,b.baseURL,b.data,b.headers);if(a.success){let b=p;V(d=>{var e,f;let g=(0,_HTTPHelper.parseResponseResultsHierarchy)(t,a.data);const h=d.map(a=>a[c]),i=null!==(e=null===(f=g)||void 0===f?void 0:f.filter(a=>h.includes(a[c])))&&void 0!==e?e:[];if(0<i.length){var j,k;_LogHelper.default.LogWarning("there is some duplication in the data, we will remove the duplicated options for you, but you need to fix this issue, the duplicated data are:"),_LogHelper.default.LogWarning(i),g=null!==(j=null===(k=g)||void 0===k?void 0:k.filter(a=>!h.includes(a[c])))&&void 0!==j?j:[]}const l=[...d,...g];return b=0===l.length?p:l.length,l}),_(b+p),_LogHelper.default.LogMessage("new start from",b+p)}else P(!0);fa.current=b}I&&J(!1),K&&L(!1),S&&T(!1),N(!1)};(0,_react.useEffect)(()=>{S&&(_(p),V([]),ga(p))},[S]),(0,_react.useEffect)(()=>{I&&(_LogHelper.default.LogMessage("useEffect for scroll"),ga())},[I]),(0,_react.useEffect)(()=>{M?Z(!0):Q&&Z(!1)},[M]),(0,_react.useEffect)(()=>{if(!Y){var a;null===da||void 0===da||null===(a=da.current)||void 0===a?void 0:a.focus()}},[Y]),(0,_react.useEffect)(()=>{const a=setTimeout(()=>{K&&(_(p),V([]),_LogHelper.default.LogMessage("useEffect for search"),ga(p))},500);return()=>clearTimeout(a)},[G]);const ha=(0,_react.useCallback)((a,b)=>{z?X(d=>a?[...d,b]:[...d.filter(a=>a[c]!==b[c])]):X(()=>a?[b]:[])}),ia=(a,b)=>{let d=b.find(b=>b[c]===a[c]);return!!d},ja=a=>{a.target.value!==G&&(H(a.target.value),L(!0))},ka=a=>{let b=Math.trunc(a.scrollTop/F);b=b-E>=U.length?b-E:b,b!==aa.start&&ba({start:b,end:b+E>=U.length?U.length-1:b+E})},la=(0,_react.useRef)(!1);(0,_react.useEffect)(()=>{y(W)},[W]);_LogHelper.default.LogMessage("local data length",U.length);const ma=D?{height:U.length*F,minHeight:U.length*F}:{};return/*#__PURE__*/_react.default.createElement("div",{className:"lazyselect"},/*#__PURE__*/_react.default.createElement("div",{className:"lazyselect-select-wrapper"},/*#__PURE__*/_react.default.createElement("div",{className:"lazyselect-select"},/*#__PURE__*/_react.default.createElement("div",{onClick:a=>{(a.target.classList.contains("icon")||a.target.classList.contains("lazyselect-select-output")||a.target.classList.contains("arrow"))&&(Q?(R(!1),H(""),_(p),V([]),Z(!0)):(R(!0),T(!0),Z(!1)))},className:Q?"lazyselect-select-output active":"lazyselect-select-output"},(()=>{if(z){if(A)return/*#__PURE__*/_react.default.createElement(_TagsInput.default,{uniqueKey:c,displayBy:d,Filterable:e,placeHolder:f,selectedDataList:W,renderedSelectedDataList:0>=w?W:W.slice(0,w),onSearchChange:ja,searchValue:G,handleOptionSelectedUnselected:ha,displayShowMoreOption:v,maximunOptionToShow:w,displayShowMoreOptionCallBack:x,tagsInputDisabled:Y,TagComponent:B,ShowMoreComponent:C});}else if(W[0])return/*#__PURE__*/_react.default.createElement("div",{className:"tags-input"},/*#__PURE__*/_react.default.createElement("input",{ref:da,autoFocus:!0,disabled:Y||!e,type:"text",value:G,onChange:ja,placeholder:W[0][d]}));return/*#__PURE__*/_react.default.createElement("div",{className:"tags-input"},/*#__PURE__*/_react.default.createElement("input",{ref:da,autoFocus:!0,disabled:Y||!e,type:"text",onChange:ja,value:G,placeholder:f}))})(),/*#__PURE__*/_react.default.createElement("div",{className:"icon",style:{lineHeight:Q?"49px":"46px"}},/*#__PURE__*/_react.default.createElement("i",{className:"arrow ".concat(Q?"up":"down")}))),/*#__PURE__*/_react.default.createElement("div",{ref:ca,className:Q?"lazyselect-select-box show":"lazyselect-select-box",onScroll:()=>{const a=ca.current;D&&ka(a);const b=(0,_ScrollHelper.isElementAtBottom)(a,.98);b&&b!==la.current&&J(!0),la.current=b}},/*#__PURE__*/_react.default.createElement("div",{className:"lazyselectcheckbox-list-container",style:ma},(()=>U.map((a,b)=>{if(D&&!(b>=aa.start&&b<=aa.end))return null;let c=ia(a,W);return/*#__PURE__*/_react.default.createElement(_LazyOption.default,{key:b,index:b,optionSelected:c,DisplayCheckBoxForOptions:u,handleOptionSelectedUnselected:ha,value:a,DisplayBy:d,itemheight:F,Virtualized:D,FirstVirtualOption:!!D&&b===aa.start})}))()),M&&/*#__PURE__*/_react.default.createElement("div",{className:"lazyselect-select-buttons"},"Loading ...."),O&&/*#__PURE__*/_react.default.createElement("div",{className:"lazyselect-select-buttons"},"Somthing went wrong!, Check your server!")))))});var _default=LazySelect;exports.default=_default;